using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Sockets;
using System.Text;

namespace ScrcpyConsoleControl
{
    internal static class Program
    {
        // 서버는 텍스트 라인 기반 프로토콜을 사용한다.
        // 예: "TAP x y", "DRAG x1 y1 x2 y2 durationMs", "CLIP_GET", "CLIP_SET <base64>"
        private const string CommandTap = "TAP";
        private const string CommandDrag = "DRAG";
        private const string CommandClipGet = "CLIP_GET";
        private const string CommandClipSet = "CLIP_SET";
        private const string CommandKeycode = "KEYCODE";

        // 안드로이드 KEYCODE_PASTE = 279 (android.view.KeyEvent)
        private const int AndroidKeycodePaste = 279;

        public static int Main(string[] args)
        {
            Options opt = Options.Parse(args);

            Console.WriteLine(string.Format("[connect] {0}:{1}", opt.Host, opt.Port));
            Console.WriteLine();

            using (TcpClient tcp = new TcpClient())
            {
                tcp.Connect(opt.Host, opt.Port);
                tcp.NoDelay = true;

                // UTF-8 BOM이 송신되면 서버가 "﻿TAP"처럼 BOM 포함 문자열로 인식한다.
                // 따라서 BOM 없는 UTF-8 인코딩을 명시한다.
                Encoding utf8NoBom = new UTF8Encoding(false);

                using (NetworkStream stream = tcp.GetStream())
                using (StreamReader reader = new StreamReader(stream, utf8NoBom))
                using (StreamWriter writer = new StreamWriter(stream, utf8NoBom))
                {
                    // StreamWriter는 기본적으로 버퍼링을 사용하므로 AutoFlush를 활성화한다.
                    writer.NewLine = "\n";
                    writer.AutoFlush = true;

                    Console.WriteLine("Commands:");
                    Console.WriteLine("  tap x y");
                    Console.WriteLine("  drag x1 y1 x2 y2 durationMs steps");
                    Console.WriteLine("  setclip text...");
                    Console.WriteLine("  pasteclip text...");
                    Console.WriteLine("  getclip");
                    Console.WriteLine("  exit");
                    Console.WriteLine();

                    RunCommandLoop(reader, writer);
                }
            }

            return 0;
        }

        private static void RunCommandLoop(StreamReader reader, StreamWriter writer)
        {
            while (true)
            {
                Console.Write("> ");
                string line = Console.ReadLine();
                if (line == null)
                {
                    break;
                }

                line = line.Trim();
                if (line.Length == 0)
                {
                    continue;
                }

                List<string> parts = SplitArgs(line);
                if (parts.Count == 0)
                {
                    continue;
                }

                string cmd = parts[0].ToLowerInvariant();

                if (cmd == "exit" || cmd == "quit")
                {
                    break;
                }

                if (cmd == "tap")
                {
                    if (parts.Count < 3)
                    {
                        Console.WriteLine("usage: tap x y");
                        continue;
                    }

                    int x = int.Parse(parts[1]);
                    int y = int.Parse(parts[2]);
                    SendTap(writer, x, y);
                    ReadAndPrintResponse(reader, "tap");
                    continue;
                }

                if (cmd == "drag")
                {
                    if (parts.Count < 6)
                    {
                        Console.WriteLine("usage: drag x1 y1 x2 y2 durationMs steps");
                        continue;
                    }

                    int x1 = int.Parse(parts[1]);
                    int y1 = int.Parse(parts[2]);
                    int x2 = int.Parse(parts[3]);
                    int y2 = int.Parse(parts[4]);
                    int durationMs = int.Parse(parts[5]);

                    // steps 인수는 서버 프로토콜에 존재하지 않아 무시한다.
                    SendDrag(writer, x1, y1, x2, y2, durationMs);
                    ReadAndPrintResponse(reader, "drag");
                    continue;
                }

                if (cmd == "setclip")
                {
                    if (parts.Count < 2)
                    {
                        Console.WriteLine("usage: setclip text...");
                        continue;
                    }

                    // 과거 사용 패턴인 "setclip pasteFlag text..."도 허용한다( pasteFlag는 무시 ).
                    int textStartIndex = 1;
                    if (parts.Count >= 3 && (parts[1] == "0" || parts[1] == "1"))
                    {
                        textStartIndex = 2;
                    }

                    string text = string.Join(" ", parts.GetRange(textStartIndex, parts.Count - textStartIndex));
                    SendClipboardSet(writer, text);
                    ReadAndPrintResponse(reader, "setclip");
                    continue;
                }

                if (cmd == "pasteclip")
                {
                    if (parts.Count < 2)
                    {
                        Console.WriteLine("usage: pasteclip text...");
                        continue;
                    }

                    string text = string.Join(" ", parts.GetRange(1, parts.Count - 1));
                    SendClipboardSet(writer, text);
                    ReadAndPrintResponse(reader, "setclip");

                    // 클립보드 세팅 후 붙여넣기 키코드를 전송한다.
                    SendKeycode(writer, AndroidKeycodePaste, "both");
                    ReadAndPrintResponse(reader, "pasteclip");
                    continue;
                }

                if (cmd == "getclip")
                {
                    SendClipboardGet(writer);
                    ReadAndPrintResponse(reader, "getclip");
                    continue;
                }

                Console.WriteLine("unknown command");
            }
        }

        private static void SendTap(StreamWriter writer, int x, int y)
        {
            // 서버 컨트롤 프로토콜: "TAP x y"
            writer.WriteLine(string.Format("{0} {1} {2}", CommandTap, x, y));
        }

        private static void SendDrag(StreamWriter writer, int x1, int y1, int x2, int y2, int durationMs)
        {
            // 서버 컨트롤 프로토콜: "DRAG x1 y1 x2 y2 durationMs"
            writer.WriteLine(string.Format("{0} {1} {2} {3} {4} {5}", CommandDrag, x1, y1, x2, y2, durationMs));
        }

        private static void SendClipboardGet(StreamWriter writer)
        {
            // 서버 컨트롤 프로토콜: "CLIP_GET"
            writer.WriteLine(CommandClipGet);
        }

        private static void SendClipboardSet(StreamWriter writer, string text)
        {
            // 서버는 CLIP_SET 인수로 base64 텍스트를 기대한다.
            string encoded = Convert.ToBase64String(Encoding.UTF8.GetBytes(text));
            writer.WriteLine(string.Format("{0} {1}", CommandClipSet, encoded));
        }

        private static void SendKeycode(StreamWriter writer, int keycode, string action)
        {
            // 서버 컨트롤 프로토콜: "KEYCODE <code> <action>"
            writer.WriteLine(string.Format("{0} {1} {2}", CommandKeycode, keycode, action));
        }


        private static void ReadAndPrintResponse(StreamReader reader, string actionLabel)
        {
            // 서버는 "OK" 또는 "ERR"로 응답한다.
            string response = reader.ReadLine();
            if (response == null)
            {
                Console.WriteLine("[warn] 서버 응답이 종료되었습니다.");
                return;
            }

            // CLIP_GET의 경우 OK 뒤의 base64를 디코딩해서 출력한다.
            if (actionLabel == "getclip" && response.StartsWith("OK "))
            {
                string payload = response.Substring(3);
                string decoded = TryDecodeBase64(payload);
                if (decoded == null)
                {
                    Console.WriteLine(string.Format("[resp] {0}", response));
                }
                else
                {
                    Console.WriteLine("[resp] OK (clipboard)");
                    Console.WriteLine(decoded);
                }
                return;
            }

            Console.WriteLine(string.Format("[resp] {0}", response));
        }

        private static string TryDecodeBase64(string payload)
        {
            if (payload == null || payload.Length == 0)
            {
                return "";
            }

            try
            {
                byte[] data = Convert.FromBase64String(payload);
                return Encoding.UTF8.GetString(data);
            }
            catch (FormatException)
            {
                return null;
            }
        }

        private static List<string> SplitArgs(string line)
        {
            List<string> list = new List<string>();
            StringBuilder sb = new StringBuilder();
            bool inQuote = false;

            for (int i = 0; i < line.Length; i++)
            {
                char c = line[i];
                if (c == '"')
                {
                    inQuote = !inQuote;
                    continue;
                }

                if (!inQuote && char.IsWhiteSpace(c))
                {
                    if (sb.Length > 0)
                    {
                        list.Add(sb.ToString());
                        sb.Length = 0;
                    }
                    continue;
                }

                sb.Append(c);
            }

            if (sb.Length > 0)
            {
                list.Add(sb.ToString());
            }
            return list;
        }

        private sealed class Options
        {
            public string Host { get; private set; } = "127.0.0.1";
            public int Port { get; private set; } = 27183;

            public static Options Parse(string[] args)
            {
                Options o = new Options();
                for (int i = 0; i < args.Length; i++)
                {
                    string a = args[i];
                    if (a == "--host")
                    {
                        o.Host = GetNextArg(args, ref i, a);
                        continue;
                    }

                    if (a == "--port")
                    {
                        o.Port = int.Parse(GetNextArg(args, ref i, a));
                        continue;
                    }
                }
                return o;
            }

            private static string GetNextArg(string[] args, ref int index, string option)
            {
                // 옵션 파라미터가 없으면 즉시 에러를 던져 원인을 명확히 한다.
                if (index + 1 >= args.Length)
                {
                    throw new ArgumentException("Missing value for " + option);
                }

                index += 1;
                return args[index];
            }
        }
    }
}
